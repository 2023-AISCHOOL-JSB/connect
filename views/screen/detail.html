{% extends 'layout.html'%}
{% block content %}
{% include 'components/nav.html' %}
{% include 'components/header.html' %}

<main class="detail">
    <section class="detail__box">
        {%for i in data%}
        <h1 class="detail__title">{{i.b_title}}</h1>
        <div class="detail__info">
            <span class="post-date" data-date="{{ i.created_at }}">-</span>
            <span>{{i.user_name}}</span>
        </div>
        {% if loginUser and loginUser.user_id == i.user_id %}
        <div>
            <span>수정</span>
            <span id="delete-post-btn" style="cursor: pointer;">삭제</span>
        </div>
        {% endif %}
        <table class="detail__table">
            {%if i.b_type == '모집'%}
            <tr>
                <td class="detail__table--title">모집구분</td>
                <td class="detail__table--desc" data-array="{{ i.b_category }}" data-index="0">-</td>
            </tr>
            <tr>
                <td class="detail__table--title">마감일</td>
                <td class="detail__table--desc" data-array="{{ i.b_category }}" data-index="2">-</td>
            </tr>
            <tr>
                <td class="detail__table--title">모집인원</td>
                <td class="detail__table--desc" data-array="{{ i.b_category }}" data-index="1" data-prepend="명">-</td>
            </tr>
            <tr>
                <td class="detail__table--title">기술스택</td>
                <!-- data-index = 배열의 3번째다 -->
                <td class="detail__table--desc" data-array="{{ i.b_category }}" data-index="3"></td>
            </tr>
            {%else %}
            {%endif%}
        </table>
        <section class="detail__desc">
            {{ i.b_content|safe}}
        </section>
        <div class="detail__buttons">
            <a href="/chat">Chat</a>
            <a href="/">github</a>
            <button type="button"><i class="fa-regular fa-heart"></i> <span class="detail__like"> 5</span></button>
        </div>
        <form class="detail__msg" action="/addComment" method="POST">
            <h1 class="detail__msg--title">댓글수 <span class="detail__msg--num">{{commentCount}}</span>
                <span class="wrapper">
                    <i class="fa-solid fa-rotate-right fa-lg coment-icon" style="color: #000000;"></i>
                    <i class="fa-solid fa-rotate-right fa-spin fa-lg coment-icon-hover" style="color: #000000;"></i>
                </span>
            </h1>
            <input type="hidden" name="post_idx" value="{{ data[0].b_idx }}" />
            <div>
                <input class="detail__msg--input" type="text" name="content" required />
                <button class="detail__msg--btn" type="submit">댓글 작성</button>
            </div>
        </form>
        <ul class="detail__msg-list">
            {% if comments.length > 0 %}
            <div class="comment-container">
                {% for comment in comments %}
                <div class="comment">
                    <h2>
                        <span class="user-name">{{ comment.user_name }}</span>
                        <span class="comment-date" data-date="{{ comment.created_at }}">-</span>
                    </h2>
                    <p class="comment-content">{{ comment.cmt_content }}</p>
                    {% if not loop.last %}
                    <div class="comment-separator"></div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>댓글이 존재하지 않습니다.</p>
            {% endif %}
        </ul>
        {%endfor%}
    </section>
</main>

<script>
    function populateElement(element) {
        const dataArrayRaw = element.getAttribute('data-array');
        const dataIndex = parseInt(element.getAttribute('data-index'), 10);
        const prependValue = element.getAttribute('data-prepend') || '';
        const dataArray = JSON.parse(dataArrayRaw);
        const displayValue = prependValue + dataArray[dataIndex];
        const displayValue1 = dataArray[dataIndex] + prependValue;
        element.innerHTML = displayValue;
        element.innerHTML = displayValue1;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const customElements = document.querySelectorAll('.board__group, .board__deadline, .detail__table--desc');
        customElements.forEach((element) => {
            populateElement(element);
        });

        const postDateElements = document.querySelectorAll('.post-date');
        postDateElements.forEach((element) => {
            const rawDate = element.getAttribute('data-date');
            const formattedDate = formatDate(rawDate);
            element.textContent = formattedDate;
        });

        const commentDateElements = document.querySelectorAll('.comment-date');
        commentDateElements.forEach((element) => {
            const rawDate = element.getAttribute('data-date');
            const formattedDate = formatDate(rawDate);
            const userName = element.previousElementSibling.textContent;
            element.parentElement.innerHTML = `${userName} | ${formattedDate}`;
        });
    });

    function formatDate(dateString) {
        const date = new Date(dateString);
        const formatter = new Intl.DateTimeFormat('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });

        return formatter.format(date);
    }

    document.addEventListener("DOMContentLoaded", function () {
        const deletePostBtn = document.querySelector("#delete-post-btn");
        if (deletePostBtn) {
            deletePostBtn.addEventListener("click", handleDeletePost);
            async function handleDeletePost() {
                const postIdx = document.querySelector('input[name="post_idx"]').value;

                const response = await fetch(`/deletePost/${postIdx}`, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    alert('글이 성공적으로 삭제되었습니다.');
                    window.location.href = '/'; // 또는 다른 페이지로 이동
                } else {
                    alert('글 삭제 중 오류가 발생했습니다.');
                }
            }
        }
    });
</script>
{% endblock %}